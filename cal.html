<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
  <h1>₩₩₩ 정산합시다 ₩₩₩</h1>
  <div>
    <h3>인원</h3>
    <div class="input-group col-lg-4">
      <input type="text" class="form-control user-cnt" name="user" value="" placeholder="명" disabled>
      <input type="text" class="form-control user-name" name="user-name" placeholder="이름">
    </div>
    <div class="user-list"></div>

    <div class="selectUser" hidden>
      <select class="selectUsers form-control" name="selectUsers" id="selectUsers_1">
        <option value="none">선결제</option>
      </select>
    </div>
  </div>
  <hr>
  <div>
    <h3>결제 항목</h3>
    <div class="col-lg-4">
      <button type="button" class="addMenu btn btn-primary">메뉴추가</button>
      <div class="menuDiv">
      </div>
    </div>
  </div>
  <hr>
  <div>
    <h3>총 금액</h3>
    <div class="col-lg-4">
      <input type="hidden" class="totalHiddenAmt">
      <h4>총합 : <span class="totalAmt"></span> 원</h4>
      <h4>1인당 금액 : <span class="text-danger payAmt"></span> 원</h4>
    </div>
  </div>
  <hr>
  <div>
    <h3>정산내역</h3>
    <div class="col-lg-4">
      <div class="resultPayment">
        <table class="resultUl">
          <tr>
            <th>
              이름
            </th>
            <th>
              결제금액
            </th>
            <th>
              정산금
            </th>
          </tr>
        </table>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

  <script>
    const addBtn = document.querySelector('.addMenu');
    const menu = document.querySelector('.menuDiv');

    let person = [];
    let arrUsers = [];

    let number = 1;
    addBtn.addEventListener('click', function(){
      
      let newDiv = createDiv("newPaymentDiv", number);
      newDiv.append(createInput("menu", number));
      newDiv.append(createInput("price", number));

      //select 복사
      const el = createSelect(number+1);

      newDiv.append(el);
      newDiv.append(createButton("newPaymentDiv", number));

      menu.append(newDiv);
      number++;
    });

    function createDiv(divName, number){
      let newDiv = document.createElement("div");
      newDiv.setAttribute("class", "input-group "+divName+"_"+number);
      
      return newDiv;
    }

    function createButton(btnName, number){
      let newBtn = document.createElement("button");
      newBtn.setAttribute("class", "btn btn-danger "+btnName+"_"+number);
      newBtn.append("X");

      //# 버튼 삭제 추가
      newBtn.addEventListener("click", deleteToDo);

      return newBtn;
    }

    function createInput(text, number){
      let newObjInput = document.createElement("input");
        newObjInput.setAttribute("type", "text");
        newObjInput.setAttribute("class", "form-control "+text);
        newObjInput.setAttribute("name", text+"_"+number);
        newObjInput.setAttribute("value", "");
        newObjInput.setAttribute("placeholder", text);

      return newObjInput;
    }

    //# 대상자 선택 복사
    function createSelect(number){
      const cloneEL = document.querySelector(".selectUsers").cloneNode(true);
      $(cloneEL).prop("id", "selectUsers_"+number);
      return cloneEL;
    }

    //# 대상자 추가
    $(".user-name").on("change", function(){
      //# 중복 추가 방지
      let flag = false;
      const addName = $(this).val().trim();

      if(addName == "") flag = true;

      $(".selectUsers option").each(function (e, i){
        if(i.value == addName){
          flag = true;
          return flag;
        }
      });

      if(flag) return false;

      person.push({name : addName, amt: 0});

      //#option 추가
      $(".selectUsers").append("<option value='"+addName+"'>"+addName+"</option>")

      //# 대상자 확인
      $(".user-list").append("<input type='button' class='del-user' value='"+addName+"'>");

      //# 정산내역
      $(".resultUl").append("<tr><td>"+addName+"</td><td class='user_amt' data-option='"+ addName +"'>0</td><td class='result_amt'>0</td></tr>");

      $(".user-cnt").val($("#selectUsers_1 option").length-1);

      priceAmt();

      $(".user-name").val("");
    });

    $(document).on("click", "input.del-user", function(){
      const removeName = $(this).val();
      $(this).remove();

      $(".selectUsers option[value="+removeName+"]").remove();

      $(".user-cnt").val($("#selectUsers_1 option").length-1);

      $(".resultUl td").each(function(e, i){
        if(i.innerText == removeName){
          $(this).remove();
        }
        priceAmt();
      });
    });


    // X button을 누르면 삭제하는 함수
    function deleteToDo(event) {
      const div = event.target.parentElement;
      div.remove();

      priceAmt();
    }


    //# price 금액 합산
    $(document).on("propertychange change paste input", "input.price", function(){
      //# 각 정산

      priceAmt();
    });

    //# input 값 계산기
    function priceAmt() {
      let sum = 0;
      let amt = 0;

      $('input[name*=price]').each(function(e, i){
        //# 값 미입력시 초기값 설정
        if(isNaN($(this).val()) || $(this).val() == '') {
          $(this).val("");
        }
        amt = parseInt($(this).val());
        sum += amt;

        if(isNaN(sum)) sum = 0;

      });

      $(".totalAmt").text(sum);

      if($(".user-cnt").val() == 0) $(".user-cnt").val("1");

      const amtPerson = Math.ceil(sum / $(".user-cnt").val());
      $(".payAmt").text(amtPerson);

    }

    //# 대상자 선택시 해당 금액에 data-option 추가
    $(document).on("change", ".selectUsers", function(e, i){

      //# 각 정산
      const selectedOption = $('option:selected', $(this));
      const selectedValue = selectedOption.val();

      $(this).prev().prop("data-option", selectedValue);

      priceSum(selectedValue);

    });

    //# 각 input price의 합
    function priceSum(user){

      arrUsers = [];
      amtUser  = [];
      let obj = {};
      let arr = [];
      let resultObj = {};

      $('option:selected:gt(0)').each(function(e, i){

        let price = $(this).parent().parent().children('.price').val();
        let arr_name = $(this).text();
        let amt = 'amt_'+ e;

        if(obj[arr_name]){
          obj[arr_name][amt] = price;
        }else{
          obj[arr_name] = { [amt] : price }
        }

        let sumObj = {};
        for (let key1 in obj) {
          for (let key2 in obj[key1]) {
            if(!sumObj[key1]){
              sumObj[key1] = 0;
            }
            sumObj[key1] += parseInt(obj[key1][key2]);
          }
        }
        resultObj = sumObj;

      });

      //# 정산내역 변경
      $('.user_amt').each(function(){
        let userAmt = resultObj[$(this).data('option')];
        if(isNaN(userAmt)) userAmt = 0;
        $(this).text(userAmt + "원");

        const resultAmt = userAmt - $('.payAmt').text();

        let resultHtml = '';
        if(resultAmt >= 0){
           resultHtml = resultAmt + '원을 받으세요.';
        }else{
          resultHtml = resultAmt + '원을 내세요.';
        }
        $(this).next().text(resultHtml);  //# 각 결제 금액이 1인당 금액을 초과 또는 미만 확인
      });

      $.each(person, function(i, e) {
        if(e.name == name){
          e.amt += parseInt(price);
        }
      });

    }

    //# 선결제 대상 선택
    function calculateAmt(myAmt, avgAmt){
      const moneyToGetBack = avgAmt - myAmt;

      return moneyToGetBack;
    }




  </script>
</body>
</html>